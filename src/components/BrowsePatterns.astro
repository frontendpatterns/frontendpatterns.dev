---
import { getCollection } from "astro:content";
import CategoryIllustration from "./CategoryIllustration.astro";

const categories = await getCollection("categories");
categories.sort((a, b) => a.data.title.localeCompare(b.data.title));

const normalize = (value: string | undefined) =>
	value?.toLocaleLowerCase().replace(/\s/g, "-") ?? "";

const patterns = await getCollection(
	"patterns",
	({ data }) => data.draft !== true,
);
const patternsByCategory = new Map<string, typeof patterns>();

for (const pattern of patterns) {
	const key = normalize(pattern.data.tags);
	if (!patternsByCategory.has(key)) {
		patternsByCategory.set(key, []);
	}
	patternsByCategory.get(key)!.push(pattern);
}

for (const [key, list] of patternsByCategory) {
	list.sort((a, b) => a.data.title.localeCompare(b.data.title));
	patternsByCategory.set(key, list);
}
---

<ul class="grid gap-6 sm:grid-cols-2 xl:grid-cols-3">
	{
		categories.map((category) => {
			const categoryPatterns =
				patternsByCategory.get(normalize(category.data.title)) ??
				patternsByCategory.get(category.id) ??
				[];
			const featuredPatterns = categoryPatterns.slice(0, 3);
			const remainingCount = categoryPatterns.length - featuredPatterns.length;

			return (
				<li class="grid grid-rows-[auto_auto_minmax(0,1fr)_auto]">
					<article
						class="group grid grid-rows-[subgrid] row-span-full gap-4 rounded-2xl border border-slate-200 bg-white p-5 shadow-sm transition hover:-translate-y-1 hover:shadow-lg focus-within:outline-none focus-within:ring-2 focus-within:ring-sky-500 focus-within:ring-offset-2 focus-within:ring-offset-white dark:border-slate-800 dark:bg-slate-900 dark:hover:shadow-lg dark:focus-within:ring-offset-slate-900"
					>
						<a
							href={`/t/${category.id}`}
							class="grid items-start gap-4 rounded-xl focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sky-500 focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:focus-visible:ring-offset-slate-900 md:grid-cols-[auto,1fr]"
						>
							<CategoryIllustration slug={category.id} title={category.data.title} />
							<div class="space-y-2">
								<h3 class="text-lg font-semibold text-slate-900 transition-colors group-hover:text-sky-700 dark:text-slate-100 dark:group-hover:text-sky-300">
									{category.data.title}
								</h3>
								{category.data.description ? (
									<p class="text-sm leading-relaxed text-slate-600 dark:text-slate-300">
										{category.data.description}
									</p>
								) : null}
							</div>
						</a>
						{featuredPatterns.length ? (
							<ul class="grid gap-2 text-sm text-slate-600 transition group-hover:text-slate-700 dark:text-slate-300 dark:group-hover:text-slate-200">
								{featuredPatterns.map((pattern, index) => (
									<li class="flex flex-wrap items-center gap-2">
										<a
											href={`/${pattern.id}`}
											class="inline-flex items-center gap-2 font-semibold text-sky-700 underline decoration-slate-200 decoration-2 underline-offset-4 transition hover:text-sky-800 hover:decoration-sky-500 focus-visible:text-sky-800 dark:text-sky-300 dark:decoration-slate-700 dark:hover:text-sky-200 dark:hover:decoration-sky-400"
										>
											<span
												class="h-1.5 w-1.5 shrink-0 rounded-full bg-current"
												aria-hidden="true"
											/>
											{pattern.data.title}
										</a>
										{index === featuredPatterns.length - 1 && remainingCount > 0 ? (
											<span class="font-medium text-slate-500 dark:text-slate-400">
												+ {remainingCount} more
											</span>
										) : null}
									</li>
								))}
							</ul>
						) : (
							<p class="text-sm italic text-slate-500 dark:text-slate-400">
								Patterns coming soon.
							</p>
						)}
						<a
							href={`/t/${category.id}`}
							class="mt-auto inline-flex items-center gap-2 text-sm font-medium text-sky-700 transition hover:text-sky-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sky-500 focus-visible:ring-offset-2 focus-visible:ring-offset-white group-hover:text-sky-800 dark:text-sky-300 dark:hover:text-sky-200 dark:focus-visible:ring-offset-slate-900 dark:group-hover:text-sky-200"
						>
							Browse
							<svg
								class="h-4 w-4 transition-transform group-hover:translate-x-1"
								viewBox="0 0 20 20"
								fill="currentColor"
								aria-hidden="true"
							>
								<path
									fill-rule="evenodd"
									d="M10.293 3.293a1 1 0 0 1 1.414 0l5 5a1 1 0 0 1 0 1.414l-5 5a1 1 0 1 1-1.414-1.414L13.586 10H4a1 1 0 1 1 0-2h9.586l-3.293-3.293a1 1 0 0 1 0-1.414z"
									clip-rule="evenodd"
								/>
							</svg>
						</a>
					</article>
				</li>
			);
		})
	}
</ul>
