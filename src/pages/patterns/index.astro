---
import { getCollection } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import Search from "../../components/Search.astro";
import EmailSignup from "../../components/EmailSignup.astro";

const patterns = (
  await getCollection("patterns", ({ data }) => data.draft !== true)
).sort((a, b) => {
  const aTime = a.data.added instanceof Date ? a.data.added.getTime() : 0;
  const bTime = b.data.added instanceof Date ? b.data.added.getTime() : 0;
  return bTime - aTime;
});

const now = Date.now();

const patternRows = patterns.map((pattern) => {
  const addedDate =
    pattern.data.added instanceof Date
      ? pattern.data.added
      : new Date(pattern.data.added);
  const category = pattern.data.category ?? "Uncategorized";
  const categorySlug = pattern.data.category
    ? pattern.data.category.toLocaleLowerCase()
    : null;

  return {
    slug: pattern.id,
    number: pattern.data.id,
    title: pattern.data.title,
    category,
    categoryHref: categorySlug ? `/patterns/${categorySlug}` : null,
    addedDisplay: addedDate.toLocaleDateString("en-GB", {
      year: "numeric",
      month: "short",
      day: "numeric",
    }),
    isNew: now - addedDate.getTime() < 30 * 24 * 60 * 60 * 1000,
  };
});
---

<BaseLayout>
  <header class="space-y-3 pt-10 text-balance">
    <p
      class="text-sm font-semibold uppercase tracking-[0.25em] text-slate-500 dark:text-slate-400"
    >
      Catalog
    </p>
    <h1
      class="text-4xl font-bold tracking-tight text-slate-900 dark:text-slate-100 md:text-5xl"
    >
      All patterns
    </h1>
    <p class="text-base text-slate-600 dark:text-slate-300">
      Browse {patternRows.length} battle-tested architecture patterns covering components,
      state, performance, accessibility, security, and more.
    </p>
  </header>

  <div
    class="flex flex-col gap-4 rounded-2xl border border-slate-200 bg-white/80 p-5 shadow-lg shadow-slate-900/10 dark:border-slate-800 dark:bg-slate-900/70 dark:shadow-none sm:flex-row sm:items-center sm:justify-between"
  >
    <div>
      <h2 class="text-lg font-semibold text-slate-900 dark:text-slate-100">
        Looking for something specific?
      </h2>
      <p class="text-sm text-slate-600 dark:text-slate-400">
        Use quick search or skim the table to jump straight to a pattern detail
        page.
      </p>
    </div>
    <div class="w-full sm:w-auto">
      <Search variant="small" />
    </div>
  </div>

  {
    patternRows.length ? (
      <div class="overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm dark:border-slate-800 dark:bg-slate-900">
        <table class="w-full border-collapse text-left">
          <thead class="bg-slate-100/80 text-xs uppercase tracking-wide text-slate-600 dark:bg-slate-800 dark:text-slate-300">
            <tr>
              <th class="px-3 py-2 font-semibold md:px-6 md:py-3">ID</th>
              <th class="px-3 py-2 font-semibold md:px-6 md:py-3">Pattern</th>
              <th class="px-3 py-2 font-semibold md:px-6 md:py-3">Category</th>
              <th class="px-3 py-2 font-semibold text-right md:px-6 md:py-3">
                Added
              </th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-200 text-sm dark:divide-slate-800">
            {patternRows.map((pattern) => (
              <tr class="transition-colors hover:bg-slate-50 dark:hover:bg-slate-800/60">
                <td class="px-3 py-3 font-mono text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400 md:px-6">
                  #{pattern.number.toString().padStart(3, "0")}
                </td>
                <td class="px-3 py-3 md:px-6">
                  <a
                    href={`/pattern/${pattern.slug}`}
                    class="font-semibold text-slate-900 underline decoration-slate-200 decoration-2 underline-offset-4 transition hover:text-sky-700 hover:decoration-sky-500 dark:text-slate-100 dark:decoration-slate-700 dark:hover:text-sky-300 dark:hover:decoration-sky-400"
                  >
                    {pattern.title}
                    {pattern.isNew ? (
                      <span class="ml-2 inline-block rounded-full bg-sky-100 px-2 py-0.5 text-xs font-semibold text-sky-800 dark:bg-sky-800/20 dark:text-sky-200">
                        NEW
                      </span>
                    ) : null}
                  </a>
                </td>
                <td class="px-3 py-3 text-slate-600 dark:text-slate-300 md:px-6">
                  {pattern.categoryHref ? (
                    <a
                      href={pattern.categoryHref}
                      class="underline decoration-slate-200 decoration-2 underline-offset-4 transition hover:text-sky-700 hover:decoration-sky-500 dark:text-slate-200 dark:decoration-slate-700 dark:hover:text-sky-300 dark:hover:decoration-sky-400"
                    >
                      {pattern.category}
                    </a>
                  ) : (
                    pattern.category
                  )}
                </td>
                <td class="px-3 py-3 text-right text-slate-500 dark:text-slate-400 md:px-6">
                  {pattern.addedDisplay}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    ) : (
      <p class="rounded-xl border border-dashed border-slate-300 bg-slate-100/60 px-4 py-10 text-center text-sm text-slate-600 dark:border-slate-700 dark:bg-slate-900/40 dark:text-slate-400">
        No patterns have been published yet. Check back soon!
      </p>
    )
  }
  <EmailSignup />
</BaseLayout>
