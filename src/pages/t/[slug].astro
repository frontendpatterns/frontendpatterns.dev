---
import { getCollection } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import { render } from "astro:content";
import EmailSignup from "../../components/EmailSignup.astro";

const { slug } = Astro.params;

export async function getStaticPaths() {
  const categories = await getCollection("categories", ({ data }) => {
    return data.draft !== true;
  });
  return categories.map((tags) => ({
    params: { slug: tags.id },
    props: { tags },
  }));
}

const { tags } = Astro.props;
const { Content } = await render(tags);
const patterns = (
  await getCollection("patterns", (pattern) => {
    if (pattern.data.draft) return false;
    return (
      pattern.data.tags?.toLocaleLowerCase()?.replace(/\s/g, "-") ===
      slug.toLocaleLowerCase()
    );
  })
).sort((a, b) => a.data.title.localeCompare(b.data.title));

const guides = (
  await getCollection("guides", (guide) => {
    if (guide.data.draft) return false;
    return (
      guide.data.tags?.toLocaleLowerCase()?.replace(/\s/g, "-") ===
      slug.toLocaleLowerCase()
    );
  })
).sort((a, b) => a.data.title.localeCompare(b.data.title));
---

<BaseLayout>
  <section class="space-y-3 pt-10 text-balance">
    <nav
      aria-label="Breadcrumb"
      class="text-xs font-semibold uppercase tracking-[0.15em] text-slate-500 dark:text-slate-400"
    >
      <ol class="flex flex-wrap items-center gap-1">
        <li>
          <a href="/">Home</a>
        </li>
        <li aria-hidden="true">/</li>
        <li aria-current="page">
          <span>{tags.data.title}</span>
        </li>
      </ol>
    </nav>

    <h1
      class="text-5xl md:text-6xl font-bold tracking-tight text-slate-900 dark:text-slate-100"
    >
      {tags.data.title}
    </h1>

    <article
      class="prose prose-slate max-w-none dark:prose-invert prose-h1:hidden"
    >
      <Content />
    </article>
  </section>

  <section class="space-y-4">
    <h2
      class="text-2xl font-semibold tracking-tight text-slate-900 dark:text-slate-100"
    >
      {tags.data.title} Guides
    </h2>

    {
      guides.length ? (
        <div class="overflow-x-auto rounded-xl border border-slate-200 bg-white shadow-sm shadow-slate-900/5 dark:border-slate-800 dark:bg-slate-900/60 dark:shadow-none">
          <table class="min-w-full divide-y divide-slate-200 text-left text-sm dark:divide-slate-800">
            <thead class="bg-slate-50/80 dark:bg-slate-900">
              <tr>
                <th
                  scope="col"
                  class="px-4 py-3 font-semibold text-slate-600 dark:text-slate-300"
                >
                  Guide
                </th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-100 dark:divide-slate-800">
              {guides.map((guide) => (
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/70">
                  <td class="px-4 py-3 w-full">
                    <a
                      class="font-semibold text-sky-700 underline-offset-2 transition hover:text-sky-900 hover:underline dark:text-sky-300 dark:hover:text-sky-200"
                      href={`/guides/${guide.id}`}
                    >
                      {guide.data.title}
                      {new Date() - new Date(guide.data.publishedAt) <
                      30 * 24 * 60 * 60 * 1000 ? (
                        <span class="ml-2 inline-block rounded-full bg-sky-100 px-2 py-0.5 text-xs font-semibold text-sky-800 dark:bg-sky-800/20 dark:text-sky-200">
                          NEW
                        </span>
                      ) : null}
                    </a>
                    {guide.data.description && (
                      <p class="mt-1 text-xs text-slate-600 dark:text-slate-400">
                        {guide.data.description}
                      </p>
                    )}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      ) : (
        <p class="rounded-lg border border-dashed border-slate-300 bg-slate-100/60 px-4 py-6 text-sm text-slate-600 dark:border-slate-700 dark:bg-slate-900/40 dark:text-slate-400">
          No guides have been published in this category yet.
        </p>
      )
    }
  </section>

  <section class="space-y-4">
    <h2
      class="text-2xl font-semibold tracking-tight text-slate-900 dark:text-slate-100"
    >
      {tags.data.title} Patterns
    </h2>

    {
      patterns.length ? (
        <div class="overflow-x-auto rounded-xl border border-slate-200 bg-white shadow-sm shadow-slate-900/5 dark:border-slate-800 dark:bg-slate-900/60 dark:shadow-none">
          <table class="min-w-full divide-y divide-slate-200 text-left text-sm dark:divide-slate-800">
            <thead class="bg-slate-50/80 dark:bg-slate-900">
              <tr>
                <th
                  scope="col"
                  class="px-4 py-3 font-semibold text-slate-600 dark:text-slate-300"
                >
                  Pattern
                </th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-100 dark:divide-slate-800">
              {patterns.map((pattern) => (
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/70">
                  <td class="px-4 py-3 w-full">
                    <a
                      class="font-semibold text-sky-700 underline-offset-2 transition hover:text-sky-900 hover:underline dark:text-sky-300 dark:hover:text-sky-200"
                      href={`/${pattern.id}`}
                    >
                      {pattern.data.title}
                      {new Date() - new Date(pattern.data.added) <
                      30 * 24 * 60 * 60 * 1000 ? (
                        <span class="ml-2 inline-block rounded-full bg-sky-100 px-2 py-0.5 text-xs font-semibold text-sky-800 dark:bg-sky-800/20 dark:text-sky-200">
                          NEW
                        </span>
                      ) : null}
                    </a>
                    {pattern.data.description && (
                      <p class="mt-1 text-xs text-slate-600 dark:text-slate-400">
                        {pattern.data.description}
                      </p>
                    )}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      ) : (
        <p class="rounded-lg border border-dashed border-slate-300 bg-slate-100/60 px-4 py-6 text-sm text-slate-600 dark:border-slate-700 dark:bg-slate-900/40 dark:text-slate-400">
          No patterns have been published in this category yet.
        </p>
      )
    }
  </section>

  <div>
    <h2
      class="text-2xl font-semibold tracking-tight text-slate-900 dark:text-slate-100"
    >
      Get new patterns in your inbox
    </h2>
    <EmailSignup />
  </div>
</BaseLayout>
